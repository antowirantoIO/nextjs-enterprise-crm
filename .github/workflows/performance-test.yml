name: âš¡ Performance Testing

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  schedule:
    - cron: '0 4 * * *' # Daily at 4 AM

jobs:
  load-test:
    name: âš¡ Load Testing
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build application
        run: pnpm build

      - name: ðŸš€ Start application
        run: pnpm start &
        env:
          PORT: 3000

      - name: â³ Wait for application
        run: sleep 15

      - name: âš¡ Install Artillery
        run: npm install -g artillery@latest

      - name: âš¡ Run load tests
        run: |
          echo "
          config:
            target: 'http://localhost:3000'
            phases:
              - duration: 60
                arrivalRate: 5
                name: 'Warm up'
              - duration: 120
                arrivalRate: 10
                name: 'Sustained load'
              - duration: 60
                arrivalRate: 20
                name: 'Peak load'
          scenarios:
            - name: 'Homepage load'
              weight: 50
              flow:
                - get:
                    url: '/'
                - think: 1
            - name: 'API health check'
              weight: 30
              flow:
                - get:
                    url: '/api/health'
                - think: 1
            - name: 'Auth page'
              weight: 20
              flow:
                - get:
                    url: '/auth/signin'
                - think: 2
          " > artillery-config.yml
          
          artillery run artillery-config.yml --output performance-report.json

      - name: ðŸ“Š Generate performance report
        run: |
          artillery report performance-report.json --output performance-report.html

      - name: ðŸ“Š Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            performance-report.json
            performance-report.html
          retention-days: 30

  bundle-analysis:
    name: ðŸ“¦ Bundle Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ“Š Analyze bundle
        run: pnpm analyze
        env:
          ANALYZE: true

      - name: ðŸ“Š Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: .next/analyze
          retention-days: 30